/*(c)2016 sovrn Holdings, Inc. All Rights Reserved 1533844201940*/
window.sovrn=window.sovrn||{};window.sovrn=window.sovrn||{},sovrn.config=sovrn.config||{},sovrn.config.buildConfig=sovrn.config.buildConfig||{},sovrn.config.buildConfig.ct_url="//ap.lijit.com/containertag",sovrn.config.buildConfig.log_url="//ap.lijit.com/data/ct",sovrn.config.buildConfig.error_url="//ap.lijit.com/data/errors",Object.seal&&Object.seal(sovrn.config.buildConfig),sovrn.config.auction=sovrn.config.auction||{current_tid:"",instances:{},globals:{tag_regex:/^(https?:)?\/\/.*\.lijit\.(com|dev)(:\d+)?\/res\/sovrn\.containertag\.new(\.min)?\.js/i,host_regex:/(^(https?:)?\/\/.*\.lijit\.(com|dev))/,fired_tags:{},all_tags:{}}},sovrn.auction={buildQS:function(obj){var key,output=[];for(key in obj)obj.hasOwnProperty(key)&&""!==key&&""!==obj[key]&&output.push(key+"="+obj[key]);return output.join("&")},createBitmask:function(){var mask=0,flag=0,len=arguments.length>32?32:arguments.length;for(flag;len>flag;mask|=arguments[flag]<<flag++);return mask},checkFreq:function(tag){var cookie_val,first_int,second_int,third_int,fourth_int,modulo_val,return_val,tag_percent;if(!tag.frequency)return!0;switch(tag.frequency){case"sample":tag_percent=parseFloat(tag.percent),0===tag_percent?(this.setStatusCode(tag.id,"disabled"),return_val=!1):return_val=100===tag_percent||100*Math.random()<=(tag_percent||0);break;case"users":return_val=!1,100===parseInt(tag.percent,10)?return_val=!0:(modulo_val=Math.floor(1/((parseFloat(tag.percent)||0)/100)),cookie_val=this.getCookieValue("ljt_reader"),32===cookie_val.length?(first_int=parseInt(cookie_val.substr(0,8),16),second_int=parseInt(cookie_val.substr(8,8),16),third_int=parseInt(cookie_val.substr(16,8),16),fourth_int=parseInt(cookie_val.substr(24,8),16),return_val=(first_int+second_int+third_int+fourth_int)%modulo_val===0):24===cookie_val.length&&(first_int=parseInt(cookie_val.substr(0,8),16),second_int=parseInt(cookie_val.substr(8,8),16),third_int=parseInt(cookie_val.substr(16,8),16),return_val=(first_int+second_int+third_int)%modulo_val===0));break;case"timed":return_val=!0;break;default:this.reportError("Invalid Tag Freq. Type: "+tag.frequency,new Error),return_val=!1}return return_val===!1&&this.setStatusCode(tag.id,"frequency_capped"),return_val},dbgEnabled:function(){var is_debug_enabled;try{is_debug_enabled=localStorage.getItem("debug")}catch(e){}return is_debug_enabled=is_debug_enabled||(document.cookie.match(/(^|; )debug=([^;]*)/)||0)[2],1===is_debug_enabled},fireTag:function(tag){function logFireTagError(tag,exception){return _this.log("ERROR FIRING TAG "+tag.id),_this.setStatusCode(tag.id,"js_error"),_this.reportError("Tag "+tag.id+": "+tag.error.replace(/["']/g,""),exception),!1}var _this=this,config=_this.getConfig();switch(tag.type){case"img":try{(new Image).src=tag.src,config.img_tags_fired++}catch(e){return logFireTagError(tag,e)}break;case"script":try{if(eval(tag.src)===!1)return _this.setStatusCode(tag.id,"custom_js_logic_failed"),!1;config.script_tags_fired++}catch(e){return logFireTagError(tag,e)}}return this.getGlobalConfig().fired_tags[tag.id]=tag.id,config.total_tags_fired++,this.setStatusCode(tag.id,"fired"),config.tss.push(new Date-config.start_time),!0},fireTags:function(container_tags){var i,fired_script_tags,fired_image_tags,currentTag,freq_check,should_tag_fire,everything_passes,tag_fired,config=this.getConfig(),globalConfig=this.getGlobalConfig();for(config.data=container_tags,fired_script_tags=[],fired_image_tags=[],i=0;i<config.data.tags.length;i++)currentTag=config.data.tags[i],globalConfig.all_tags[currentTag.id]=currentTag.id,config.tag_status_codes[currentTag.id]=new this.statusCodesConst,freq_check=this.checkFreq(currentTag),should_tag_fire=!this.isPageCapped(currentTag),everything_passes=freq_check&&should_tag_fire,this.dbgEnabled()&&this.log("CID: "+config.container_id+" Tag: "+currentTag.id+" ("+currentTag.type+") Not Page Capped: "+should_tag_fire+" | Freq Check Passed: "+freq_check+" | FIRED: "+everything_passes),everything_passes&&(tag_fired=this.fireTag(currentTag),tag_fired&&("img"===currentTag.type?fired_image_tags.push(currentTag.id):"script"===currentTag.type&&fired_script_tags.push(currentTag.id)));this.log("Fired Image Tags: "+fired_image_tags.join(", ")+" / Script Tags: "+fired_script_tags.join(", ")),this.logToServer()},getBrowserEngine:function(){var style,engine="un";style=document.documentElement.style;try{window.chrome?engine="cr":window.ActiveXObject||"-ms-ime-align"in style?engine="ie":"mozInnerScreenX"in window&&"mozFullScreen"in document||"MozAppearance"in style?engine="fx":"WebKitCSSMatrix"in window||"WebKitPoint"in window||"webkitStorageInfo"in window||"webkitURL"in window?engine="sf":("OLink"in style||window.opera)&&(engine="op")}catch(e){}return engine},getConfig:function(tid){return tid=tid||sovrn.config.auction.current_tid,"undefined"==typeof sovrn.config.auction.instances[tid]&&(sovrn.config.auction.instances[tid]={}),sovrn.config.auction.instances[tid]},getCookieValue:function(cookie_name){if(!cookie_name||"string"!=typeof cookie_name)return"";if(cookie_name=cookie_name.toLowerCase(),-1===document.cookie.indexOf(cookie_name))return"";var cookies=document.cookie,name_index=cookies.indexOf(cookie_name),cookie=cookies.substring(name_index,cookies.indexOf(";",name_index));return cookie.split("=")[1]},getCtScriptTag:function(){var script_tags,i,script_pattern=this.getGlobalConfig().tag_regex;for(script_tags=document.getElementsByTagName("script"),i=script_tags.length-1;i>=0;i--)if(script_pattern.test(script_tags[i].src))return script_tags[i];return null},getDataFromServer:function(config){var protocol,data_uri,script_tag,query_string="?";return query_string+="zoneId="+config.zone_id,query_string+="&containerId="+config.container_id,query_string+="&v="+config.version,query_string+="&tid="+config.tid,query_string+="&loc="+(config.query_params.hasOwnProperty("loc")?config.query_params.loc:""),protocol="https:"===window.location.protocol?"https:":"http:",data_uri=protocol+sovrn.config.buildConfig.ct_url+query_string,script_tag=document.createElement("script"),script_tag.src=data_uri,document.head.appendChild(script_tag),this.log("*ct: Retrieved tag data from Raptor"),!0},getGlobalConfig:function(){return sovrn.config.auction.globals},getGUID:function(){function b(a){return a?(a^16*Math.random()>>a/4).toString(16):([1e7]+1e3+4e3+8e3+1e19).replace(/[018]/g,b)}return b()},getQueryParam:function(key,tid){var params=this.getConfig(tid).query_params||{};return params.hasOwnProperty(key)?params[key]:null},getStatusCodes:function(tid){var tsc,tag_status,tag_status_codes_arr,return_val=[],tag_status_codes=this.getConfig(tid).tag_status_codes;for(tag_status in tag_status_codes)tag_status_codes.hasOwnProperty(tag_status)&&(tsc=tag_status_codes[tag_status],tag_status_codes_arr=[tsc.fired,tsc.disabled,tsc.frequency_capped,tsc.rules_did_not_pass,tsc.once_per_page_capped,tsc.custom_js_logic_failed,tsc.js_error],return_val.push(this.createBitmask.apply(this,tag_status_codes_arr)));return return_val},isOldIE:function(user_agent_string){var pattern=new RegExp("MSIE ([0-9]+[\\.0-9]*)");return user_agent_string=user_agent_string||navigator.userAgent,"ie"===this.getBrowserEngine()&&!!pattern.exec(user_agent_string)&&parseInt(RegExp.$1)<=10},isPageCapped:function(tag){return"multi"===tag.fire?!1:this.getGlobalConfig().fired_tags.hasOwnProperty(tag.id)?(this.setStatusCode(tag.id,"once_per_page_capped"),!0):!1},log:function(msg){var ts,log_line,config,log_style="",style_templ="";return"undefined"!=typeof console&&this.dbgEnabled()?(config=this.getConfig(),ts=new Date-config.start_time,log_line="[sovrn.ct] "+ts+": "+msg+" ("+this.getTID()+")","ie"!==this.getBrowserEngine()&&(style_templ="%c",log_style="background-color: #FFED96"),console.log(style_templ+log_line,log_style),config.log+=log_line+"\n",!0):!1},logToServer:function(){var log_params,config=this.getConfig(),globalConfig=this.getGlobalConfig(),log_url=sovrn.config.buildConfig.log_url,all_tags_ids=Object.keys(globalConfig.all_tags).join(),fired_tags_ids=Object.keys(globalConfig.fired_tags).join();log_params={tid:config.tid,zoneid:config.zone_id,cid:config.container_id,geo:config.data.geo||"",all_tags:all_tags_ids,tss:config.tss.join(),fired_tags:fired_tags_ids,count:globalConfig.fired_tags.length,status:this.getStatusCodes().join()},config.elapsed_ms=log_params.elapsed_ms=new Date-config.start_time,(new Image).src=log_url+"?"+this.buildQS(log_params),this.log("Logged Container Tag Successfully")},parseQueryString:function(url){var query_string,qs_obj={};return query_string=url.split("?")[1]||"",(query_string=query_string.split("#")[0]||"")?(query_string.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function($0,$1,$2,$3){try{qs_obj[$1]=decodeURIComponent($3)}catch(e){}}),qs_obj):{}},reportError:function(msg,ex){var err_msg,stack_trace,error_handler_params,config=this.getConfig();try{stack_trace=ex&&ex.hasOwnProperty("stack")?ex.stack:"",error_handler_params={zoneid:config.zone_id||"",tid:config.tid,err:ex&&ex.hasOwnProperty("message")?ex.message:"",msg:msg,stack:stack_trace.substr(0,1024)},(new Image).src=sovrn.config.buildConfig.error_url+"/ct?"+this.buildQS(error_handler_params),this.dbgEnabled()&&(err_msg="CT JS ERROR: \n\n"+msg+"\n\n"+stack_trace,alert(err_msg),window.console&&console.error(err_msg))}catch(e){console.log(e)}return ex},setStatusCode:function(tag_id,status_code){var config=this.getConfig();try{config.tag_status_codes&&"object"==typeof config.tag_status_codes[tag_id]&&(config.tag_status_codes[tag_id][status_code]=!0)}catch(e){return this.reportError("Error Setting Status Code: "+status_code+" for Tag: "+tag_id,e),!1}return!0},statusCodesConst:function(){var _this=this;_this.fired=!1,_this.disabled=!1,_this.frequency_capped=!1,_this.rules_did_not_pass=!1,_this.once_per_page_capped=!1,_this.custom_js_logic_failed=!1,_this.js_error=!1,Object.seal&&Object.seal(_this)},init:function(){var ct_script_tag,tid,config;return this.isOldIE()?(this.log("Legacy IE detected; Aborting"),!1):(this.log("Container Tag Start"),(ct_script_tag=this.getCtScriptTag())?(ct_script_tag.id&&ct_script_tag.id.length>3&&(tid=ct_script_tag.id.substring(3)),delete sovrn.config.auction.current_tid,sovrn.config.auction.current_tid=tid||this.getGUID(),config=this.getConfig(sovrn.config.auction.current_tid),config.start_time=+new Date,config.elapsed_ms=0,config.tss=[],config.tid=sovrn.config.auction.current_tid,config.query_params=this.parseQueryString(ct_script_tag.src),config.data={},config.fired_tags={},config.all_tag_ids=[],config.fired_tag_ids=[],config.img_tags_fired=0,config.script_tags_fired=0,config.total_tags_fired=0,config.log="",config.tag_status_codes={},config.version=this.getQueryParam("v")||"3",config.container_id=this.getQueryParam("cid"),config.container_id?(config.zone_id=this.getQueryParam("zid"),config.zone_id?this.getDataFromServer(config):(this.reportError("Missing zid",new Error),!1)):(this.reportError("Missing cid",new Error),!1)):(this.reportError("Could not find CT script tag",new Error),!1))}},"undefined"!=typeof Object.seal&&(sovrn.config.auction.globals=Object.seal(sovrn.config.auction.globals),sovrn.auction=Object.seal(sovrn.auction)),sovrn.auction.init();