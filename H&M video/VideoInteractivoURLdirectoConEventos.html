<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <meta name="ad.size" content="width=320, height=480" />
        <title>Anuncio creator</title>
        <!-- <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css?family=Lato:300,700,900" rel="stylesheet">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script> -->
        <link href="https://fonts.googleapis.com/css?family=Lato:300,700,900" rel="stylesheet">
        <script>
            var videoUrl = "https://www.youtube.com/embed/xPu9lPlEs4M?autohide=2&modestbranding=1&controls=2&showinfo=0&fs=0&rel=0&disablekb=1&cc_load_policy=0";
            var linkRedirect = 'https://www2.hm.com/en_us/free-form-campaigns/1079-studio-2019.html#intro';
            var config = [
                {
                    start: 3,
                    position: [//position donde saldra el circulo sobre el video
                        'left: 90px;',
                        'top: 170px;'
                    ],
                    img_screen: 'https://i.imgur.com/hgcsJx7.png',
                    href: 'https://www2.hm.com/en_us/productpage.0733864002.html',
                },{
                    start: 3,
                    position: [
                        'left: 160px;',
                        'top: 170px;'
                    ],
                    img_screen: 'https://i.imgur.com/TtDfGcd.png',
                    href: 'https://www2.hm.com/en_us/productpage.0733852001.html'
                },
                 {
                    start: 15,
                    position: [
                        'left: 120px;',
                        'top: 170px;'
                    ],
                    img_screen: 'https://i.imgur.com/hgcsJx7.png',
                    href: 'https://www2.hm.com/en_us/productpage.0747246002.html'                    
                },{
                    start: 20,
                    position: [
                        'left: 120px;',
                        'top: 170px;'
                    ],
                    img_screen: 'https://i.imgur.com/TtDfGcd.png',
                    href: 'https://www2.hm.com/en_us/productpage.0188183022.html'                    
                }
            ];
             
            var configRemoved = {
               10: {
                    position: 3
                },
               10: {
                    position: 3
                },
                
                20: {
                    position: 15
                },
               24: {
                    position: 20
                }
            };
        </script>
        <style>
            body { margin: 0px;font-family: Lato; }
            .video-container {
                width: 100%;
                height: 100vh;
                position: relative;
            }
            .video-container .circle {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                border: 1px solid #ededed;
                background-color: #ffffff;
                cursor: pointer;
            }


            /* The Modal (background) */
            .modal {
              display: none; /* Hidden by default */
              position: fixed; /* Stay in place */
              z-index: 1; /* Sit on top */
              left: 0;
              top: 0;
              width: 100%; /* Full width */
              height: 100%; /* Full height */
              overflow: auto; /* Enable scroll if needed */
              background-color: rgb(0,0,0); /* Fallback color */
              background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            }

            /* Modal Content/Box */
            .modal .modal-content {
              background-color: #fefefe;
              margin: 5% auto; /* 15% from the top and centered */
              padding: 20px;
              border: 1px solid #888;
              width: 80%; /* Could be more or less, depending on screen size */
            }

            /* The Close Button */
            .modal .modal-content .modal-header .close {
              color: #aaa;
              float: right;
              font-size: 28px;
              font-weight: bold;
            }

            .modal .modal-content .modal-header .close:hover,
            .modal .modal-content .modal-header .close:focus {
              color: black;
              text-decoration: none;
              cursor: pointer;
            }

            .modal .modal-content .body .column {
                display: inline-block;
                vertical-align: top;
                width: 45%;
                text-align: center;
            }
            .modal .modal-content .body .movil-size {
                display: block !important;
                width: 100% !important;
            }
            .modal .modal-content .body .column img.logo {
                height: 450px;
                width: 100%;
            }
            .image-resize {
                height: 250px !important;
                width: 200px !important;
            }
            .modal .modal-content .body .column .link {
                margin-top: 30px;
            }
            .modal .modal-content .body .column .link a {
                padding: 6px 25px;
                background-color: transparent;
                border: 2px solid #333;
                text-decoration: none;
                color: #333;
            }

            /* styles for screen over video */
            .video-container .over-video {
                position: absolute;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>

        <div class="video-container">
            <iframe src="" style="width:320px;height:270px;margin-top: px; margin-left: px;" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen="" id="fitvid434752"></iframe>

            <!-- <div class="over-video"></div> -->

        </div>

        <script>
            function _initAdds() {

                var gtmYTListeners = [];
                var videoState = {
                    '0.00': false,
                    '0.25': false,
                    '0.50': false,
                    '0.75': false,
                    '1': false
                };
                var timeout = null;
                //setear link de video de config al iframe
                var iframe = document.querySelector('iframe');
                if (!iframe) {return;}

                iframe.setAttribute('src', videoUrl);

                /* Start modal click */
                // Función que hace compatibles los eventos con todos los navegadores.
                function addEvent(el, name, fn) {
                    if (el.addEventListener) {
                    el.addEventListener(name, fn);
                    } else if (el.attachEvent) {
                    el.attachEvent('on' + name, function(evt) {
                        evt.target = evt.target || evt.srcElement;
                        // Call the event to ensure uniform 'this' handling, pass it event
                        fn.call(el, evt);
                    });
                    } else if (typeof el['on' + name] === 'undefined' || el['on' + name] === null) {
                    el['on' + name] = function(evt) {
                        evt.target = evt.target || evt.srcElement;
                        // Call the event to ensure uniform 'this' handling, pass it event
                        fn.call(el, evt);
                    };
                    }
                }; 

                function goToLink(link, _name) {
                    return function() {
                        var tabName = _name == undefined ? '_blank' : _name;
                        window.open(link, tabName);
                    }
                };

                function _controlModalLinkAndScreen() {

                    // var screen = document.querySelector(".video-container .over-video");
                    // if (screen) {
                    //     addEvent(screen, 'click', function($e) {
                    //         $e.preventDefault();
                    //         $e.stopPropagation();
                    //         var href = linkRedirect;
                    //         var callback = goToLink(href);
                    //         /* Add Event 'click inner video' */
                    //         window.setTimeout(callback, 500);
                    //     });
                    // }
                    return;
                };

                _controlModalLinkAndScreen();
                /* End modal click */


                function _searchVideoInTemplate() {

                    // activar api
                    for (var e = document.getElementsByTagName("iframe"), x = e.length; x--;)
                        if (/youtube.com\/embed/.test(e[x].src))
                            if(e[x].src.indexOf('enablejsapi=') === -1)
                                e[x].src += (e[x].src.indexOf('?') ===-1 ? '?':'&') + 'enablejsapi=1';        
                };
                //scan all video and apply format
                _searchVideoInTemplate();

                function _loadScript(src, callback) {

                    var s = document.createElement('script'),
                        r =false;

                    s.type = 'text/javascript';
                    s.src = src;
                    s.onload = s.onreadystatechange = function() {
                        //console.log( this.readyState ); //uncomment this line to see which ready states are called.
                        if (!r && (!this.readyState || this.readyState == 'complete')) {
                            r = true;
                            if (callback !== undefined) {
                                callback();
                            }
                        }
                    };
                    var head = document.querySelector('head');
                    head.appendChild(s);
                };

                // añadir listener para cada reproductor
                window.onYouTubeIframeAPIReady = (function() {
                    for (var e = document.getElementsByTagName("iframe"), x = e.length; x--;) {
                        if (/youtube.com\/embed/.test(e[x].src)) {
                             gtmYTListeners.push({
                                id: e[x].src,
                                eventSend: false,
                                time: 0,
                                event: new YT.Player(e[x], {
                                    events: {
                                        onReady: onPlayerReady,
                                        onStateChange: onPlayerStateChange
                                    }
                                })
                            });
                            YT.gtmLastAction = "p";
                        }
                    }
                });

                // informar del progreso del video
                function onPlayerPercent(e) {
                    if (e["getPlayerState"]() == YT.PlayerState.PLAYING) {
                        var t = e["getCurrentTime"]();
                        t = Math.round(t);                        
                        e["lastP"] = t;
                        addCircleDescriptor(t);
                        removedCircleDescriptor(t);
                        

                        /* add video control */
                        var porcent = e["getDuration"]() - e["getCurrentTime"]() <= 1.5 ? 1 : (Math.floor(e["getCurrentTime"]() / e["getDuration"]() * 4) / 4).toFixed(2);

                        switch (porcent) {
                            case '0.00':
                                if (!videoState['0.00']) {
                                    videoState['0.00'] = true;
                                    /* Add Event '0% video' */
                                }
                                break;
                            case '0.25':
                                if (!videoState['0.25']) {
                                    videoState['0.25'] = true;
                                    /* Add Event '25% video' */
                                }
                                break;
                            case '0.50':
                                if (!videoState['0.50']) {
                                    videoState['0.50'] = true;
                                    /* Add Event '50% video' */
                                }
                                break;
                            case '0.75':
                                if (!videoState['0.75']) {
                                    videoState['0.75'] = true;
                                    /* Add Event '75% video' */
                                }
                                break;
                            default:
                                if (!videoState['1']) {
                                    videoState['1'] = true;
                                    /* Add Event '100% video' */
                                }
                                break;
                        }
                    }
                };

               
                
                
                // detectar el cambio de estado del video
                function onPlayerStateChange(e) {
                    if (e["data"] == YT.PlayerState.PLAYING && YT.gtmLastAction == "p") {
                        YT.gtmLastAction = "";
                        timeout = setInterval(onPlayerPercent, 1000, e["target"])        
                    }
                    if (e["data"] == YT.PlayerState.PAUSED) {
                        YT.gtmLastAction = "p";
                        clearInterval(timeout);
                    }
                };

                function onPlayerReady(event) {
                    event.target.playVideo();
                };
                
                //crear el modal
                function configureAndShowModal($e) {

                    //Extract position in config
                    var index = $e.currentTarget.getAttribute('data-reference');
                    var configuration = config[index];                    
                    var href = configuration.href;
                    var callback = goToLink(href, '_blank' + index);
                    /* Add Event 'click in circle an redirect' */
                    window.setTimeout(callback, 500);
                };

                function removedCircleDescriptor(segunsContainer) {

                    var keys = Object.keys(configRemoved);
                    var key = null;

                    for(var i = 0; i < keys.length; i++) {
                        if (keys[i] == segunsContainer) {
                            key = keys[i];
                            break;
                        }
                    }

                    if (key != null) {
                        key = configRemoved[keys[i]];
                        var selector = "div[data-position='"+ key.position +"']";
                        var removed = document.querySelectorAll(selector);
                        if (removed != undefined) {
                            for(var i = 0; i < removed.length; i++) {
                                removed[i].parentNode.removeChild(removed[i]);
                            }
                        }
                    }
                };
                
                
                function addCircleDescriptor(segunsContainer) {

                    var views = [];
                    for(var i = 0; i < config.length; i++) {
                        if (config[i].start == segunsContainer) {
                            views.push(i);
                        }
                    }

                    for(var i = 0; i < views.length; i++) {
                        var configInter = config[views[i]];
                        var circle = document.createElement('div');
                        var style = 'position: absolute;background-size: cover;'
                        style += 'background-image: url(' + configInter.img_screen + ');';
                        configInter.position.forEach( function(element) {
                            style += element;
                        });
                        circle.setAttribute('style', style);
                        circle.setAttribute('class', 'circle');
                        circle.setAttribute('data-position', configInter.start);
                        circle.setAttribute('data-reference', views[i]);
                        circle.onclick = function($e) {
                            $e.preventDefault();
                            $e.stopPropagation();
                            gtmYTListeners[0].event.pauseVideo();
                            configureAndShowModal($e);
                        };
                        var base = document.querySelector('.video-container');
                        if (base != undefined) {
                            base.append(circle);

                            /* Add Event 'enter circle in screen' */
                            var pos = views[i] + 1;
                            // console.log('Impresion Bola ' + pos);
                        }
                    }
                };

                function _youtubeAPIReady() {}

                _loadScript('https://www.youtube.com/iframe_api', _youtubeAPIReady);
            };

            _initAdds();
        </script>
    </body>
</html>
