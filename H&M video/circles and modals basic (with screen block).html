<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <meta name="ad.size" content="width=320, height=480" />
        <title>Anuncio creator</title>
        <!-- <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i' rel='stylesheet' type='text/css'>
        <link href="https://fonts.googleapis.com/css?family=Lato:300,700,900" rel="stylesheet">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script> -->
        <link href="https://fonts.googleapis.com/css?family=Lato:300,700,900" rel="stylesheet">
        <script>
            var videoUrl = "https://www.youtube.com/embed/xPu9lPlEs4M?autohide=2&modestbranding=1&controls=2&showinfo=0&fs=0&rel=0&disablekb=1&cc_load_policy=0";
            var config = [
                {
                    start: 3,
                    position: [//position donde saldra el circulo sobre el video
                        'left: 90px;',
                        'top: 170px;'
                    ],
                    img_screen: 'https://i.imgur.com/hgcsJx7.png',
                    detail: {//configuracion para el modal imagen, titulo, y texto de detail
                        imageUrl: './image/61E0jSM4zsL._UY606_.jpg',
                        title: 'asdasdas.com',
                        href: 'https://www.canadadry.com/#/root-of-relaxation',
                        description: 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.'
                    }
                },{
                    start: 5,
                    position: [
                        'left: 30px;',
                        'top: 150px;'
                    ],
                    img_screen: './image/61xw0y7hTIL._UY500_.jpg',
                    detail: {
                        imageUrl: './image/61xw0y7hTIL._UY500_.jpg',
                        title: 'asdasdas.com',
                        href: 'https://www.canadadry.com/#/root-of-relaxation',
                        description: 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.'
                    }
                },{
                    start: 15,
                    position: [
                        'left: 30px;',
                        'top: 30px;'
                    ],
                    img_screen: './image/D_NP_958800-MLM27800649518_072018-Q.jpg',
                    detail: {
                        imageUrl: './image/D_NP_958800-MLM27800649518_072018-Q.jpg',
                        title: 'asdasdas.com',
                        href: 'https://www.canadadry.com/#/root-of-relaxation',
                        description: 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.'
                    }
                },{
                    start: 15,
                    position: [
                        'left: 30px;',
                        'top: 150px;'
                    ],
                    img_screen: './image/zapatos-de-tacon-con-lateral-abierto-negro-mujer-talla-34-a-48-wz517_1_fr1.jpg',
                    detail: {
                        imageUrl: './image/zapatos-de-tacon-con-lateral-abierto-negro-mujer-talla-34-a-48-wz517_1_fr1.jpg',
                        title: 'asdasdas.com',
                        href: 'https://www.canadadry.com/#/root-of-relaxation',
                        description: 'Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.'
                    }
                }
            ];
             
            var configRemoved = {
               10: {
                    position: 5
                },
                20: {
                    position: 15
                }
            };
        </script>
        <style>
            body { margin: 0px;font-family: Lato; }
            .video-container {
                width: 100%;
                height: 100vh;
                position: relative;
            }
            .video-container .circle {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                border: 1px solid #ededed;
                background-color: #ffffff;
                cursor: pointer;
            }


            /* The Modal (background) */
            .modal {
              display: none; /* Hidden by default */
              position: fixed; /* Stay in place */
              z-index: 1; /* Sit on top */
              left: 0;
              top: 0;
              width: 100%; /* Full width */
              height: 100%; /* Full height */
              overflow: auto; /* Enable scroll if needed */
              background-color: rgb(0,0,0); /* Fallback color */
              background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            }

            /* Modal Content/Box */
            .modal .modal-content {
              background-color: #fefefe;
              margin: 5% auto; /* 15% from the top and centered */
              padding: 20px;
              border: 1px solid #888;
              width: 80%; /* Could be more or less, depending on screen size */
            }

            /* The Close Button */
            .modal .modal-content .modal-header .close {
              color: #aaa;
              float: right;
              font-size: 28px;
              font-weight: bold;
            }

            .modal .modal-content .modal-header .close:hover,
            .modal .modal-content .modal-header .close:focus {
              color: black;
              text-decoration: none;
              cursor: pointer;
            }

            .modal .modal-content .body .column {
                display: inline-block;
                vertical-align: top;
                width: 45%;
                text-align: center;
            }
            .modal .modal-content .body .movil-size {
                display: block !important;
                width: 100% !important;
            }
            .modal .modal-content .body .column img.logo {
                height: 450px;
                width: 100%;
            }
            .image-resize {
                height: 250px !important;
                width: 200px !important;
            }
            .modal .modal-content .body .column .link {
                margin-top: 30px;
            }
            .modal .modal-content .body .column .link a {
                padding: 6px 25px;
                background-color: transparent;
                border: 2px solid #333;
                text-decoration: none;
                color: #333;
            }

            /* styles for screen over video */
            .video-container .over-video {
                position: absolute;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>

        <div class="video-container">
            <iframe src="" style="width:100%;height:99.5%;" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen="" id="fitvid434752"></iframe>

            <div class="over-video"></div>

            <!-- The Modal -->
            <div id="myModal" class="modal">                
                <!-- Modal content -->
                <div class="modal-content">
                    <div class="modal-header">
                        <span class="close">&times;</span>
                    </div>

                    <div class="body">
                        <div class="column" id="force">
                            <img class="logo" src="">
                        </div>
                        <div class="column">
                            <div class="title"></div>
                            <div class="description"></div>
                            <div class="link">
                                <a href="javascript:;">DISCOVER</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function _initAdds() {

                var gtmYTListeners = [];
                var videoState = {
                    '0.00': false,
                    '0.25': false,
                    '0.50': false,
                    '0.75': false,
                    '1': false
                };
                var timeout = null;
                //setear link de video de config al iframe
                var iframe = document.querySelector('iframe');
                if (!iframe) {return;}

                iframe.setAttribute('src', videoUrl);

                /* Start modal click */
                // Función que hace compatibles los eventos con todos los navegadores.
                function addEvent(el, name, fn) {
                    if (el.addEventListener) {
                    el.addEventListener(name, fn);
                    } else if (el.attachEvent) {
                    el.attachEvent('on' + name, function(evt) {
                        evt.target = evt.target || evt.srcElement;
                        // Call the event to ensure uniform 'this' handling, pass it event
                        fn.call(el, evt);
                    });
                    } else if (typeof el['on' + name] === 'undefined' || el['on' + name] === null) {
                    el['on' + name] = function(evt) {
                        evt.target = evt.target || evt.srcElement;
                        // Call the event to ensure uniform 'this' handling, pass it event
                        fn.call(el, evt);
                    };
                    }
                }; 

                function goToLink(link, _name) {
                    return function() {
                        var tabName = _name == undefined ? '_blank' : _name;
                        window.open(link, tabName);
                    }
                };

                function _controlModalLinkAndScreen() {

                    var link = document.querySelector("#myModal .body .link > a");
                    if (link) {
                        addEvent(link, 'click', function($e) {
                            $e.preventDefault();
                            $e.stopPropagation();
                            var el = $e.currentTarget;
                            var href = linkRedirect;
                            var callback = goToLink(href);
                            /* Send click dicover bottom */
                            console.log('Click pantalla')
                            window.setTimeout(callback, 500);
                        });
                    }

                    var screen = document.querySelector(".video-container .over-video");
                    if (screen) {
                        addEvent(screen, 'click', function($e) {
                            $e.preventDefault();
                            $e.stopPropagation();
                            var href = linkRedirect;
                            var callback = goToLink(href);
                            /* Send click in video screen */
                            console.log('Click in video screen');
                            window.setTimeout(callback, 500);
                        });
                    }
                };

                _controlModalLinkAndScreen();
                /* End modal click */


                function _searchVideoInTemplate() {

                    // activar api
                    for (var e = document.getElementsByTagName("iframe"), x = e.length; x--;)
                        if (/youtube.com\/embed/.test(e[x].src))
                            if(e[x].src.indexOf('enablejsapi=') === -1)
                                e[x].src += (e[x].src.indexOf('?') ===-1 ? '?':'&') + 'enablejsapi=1';        
                };
                //scan all video and apply format
                _searchVideoInTemplate();

                function _loadScript(src, callback) {

                    var s = document.createElement('script'),
                        r =false;

                    s.type = 'text/javascript';
                    s.src = src;
                    s.onload = s.onreadystatechange = function() {
                        //console.log( this.readyState ); //uncomment this line to see which ready states are called.
                        if (!r && (!this.readyState || this.readyState == 'complete')) {
                            r = true;
                            if (callback !== undefined) {
                                callback();
                            }
                        }
                    };
                    var head = document.querySelector('head');
                    head.appendChild(s);
                };

                // añadir listener para cada reproductor
                window.onYouTubeIframeAPIReady = (function() {
                    for (var e = document.getElementsByTagName("iframe"), x = e.length; x--;) {
                        if (/youtube.com\/embed/.test(e[x].src)) {
                             gtmYTListeners.push({
                                id: e[x].src,
                                eventSend: false,
                                time: 0,
                                event: new YT.Player(e[x], {
                                    events: {
                                        onReady: onPlayerReady,
                                        onStateChange: onPlayerStateChange
                                    }
                                })
                            });
                            YT.gtmLastAction = "p";
                        }
                    }
                });

                // informar del progreso del video
                function onPlayerPercent(e) {
                    if (e["getPlayerState"]() == YT.PlayerState.PLAYING) {
                        var t = e["getCurrentTime"]();
                        t = Math.round(t);                        
                        e["lastP"] = t;
                        addCircleDescriptor(t);
                        removedCircleDescriptor(t);

                        /* add video control */
                        var porcent = e["getDuration"]() - e["getCurrentTime"]() <= 1.5 ? 1 : (Math.floor(e["getCurrentTime"]() / e["getDuration"]() * 4) / 4).toFixed(2);

                        switch (porcent) {
                            case '0.00':
                                if (!videoState['0.00']) {
                                    videoState['0.00'] = true;
                                    console.log('Visualizacion 0%');
                                }
                                break;
                            case '0.25':
                                if (!videoState['0.25']) {
                                    videoState['0.25'] = true;
                                    console.log('Visualizacion 25%');
                                }
                                break;
                            case '0.50':
                                if (!videoState['0.50']) {
                                    videoState['0.50'] = true;
                                    console.log('Visualizacion 50%');
                                }
                                break;
                            case '0.75':
                                if (!videoState['0.75']) {
                                    videoState['0.75'] = true;
                                    console.log('Visualizacion 75%');
                                }
                                break;
                            default:
                                if (!videoState['1']) {
                                    videoState['1'] = true;
                                    console.log('Visualizacion 100%');
                                }
                                break;
                        }
                    }
                };

                // detectar el cambio de estado del video
                function onPlayerStateChange(e) {
                    if (e["data"] == YT.PlayerState.PLAYING && YT.gtmLastAction == "p") {
                        YT.gtmLastAction = "";
                        timeout = setInterval(onPlayerPercent, 1000, e["target"])        
                    }
                    if (e["data"] == YT.PlayerState.PAUSED) {
                        YT.gtmLastAction = "p";
                        clearInterval(timeout);
                    }
                };

                function onPlayerReady(event) {
                    event.target.playVideo();
                };
                
                //crear el modal
                function configureAndShowModal($e) {

                    //Extract position in config
                    var index = $e.currentTarget.getAttribute('data-reference');
                    var configuration = config[index];

                    /* Click in circle */
                    console.log('Click Bola ' + index);
                    // dhtml.sendEvent('1', 'Formulario_Click', null);
                    /* Click in circle */
                    console.log('Impresion Pantalla Popup ' + index);
                    //remove el item cliked
                    // var selector = "div[data-position='"+ index +"']";
                    // var removed = document.querySelector(selector);
                    // if (removed != undefined) {
                    //     removed.parentNode.removeChild(removed);
                    // }
                    // Get the modal
                    var modal = document.getElementById('myModal');
                    modal.style.display = "block";
                    // Get the <span> element that closes the modal
                    var span = document.getElementsByClassName("close")[0];

                    // When the user clicks on <span> (x), close the modal
                    span.onclick = function($e) {
                        $e.preventDefault();
                        $e.stopPropagation();
                        modal.style.display = "none";
                        gtmYTListeners[0].event.playVideo();
                    };

                    var body = document.querySelector("body");
                    if (body.clientWidth < 767) {

                        var columns = document.querySelectorAll(".modal .modal-content .body .column");
                        for(var i = 0; i < columns.length; i++) {
                            if (!columns[i].classList.contains('movil-size')) {
                                columns[i].classList.add('movil-size');
                            }
                        }
                    }

                    //update image
                    var element = document.querySelector(".modal .modal-content .body img.logo");
                    if (element != undefined) {
                        element.setAttribute('src', configuration.detail.imageUrl);
                        if (body.clientWidth < 767) {
                            if (!element.classList.contains('image-resize')) {
                                element.classList.add('image-resize');
                            }
                        }else {
                            if (element.classList.contains('image-resize')) {
                                element.classList.remove('image-resize');
                            }
                        }
                    }

                    //update title
                    element = document.querySelector(".modal .modal-content .body .title");
                    if (element != undefined) {
                        element.innerHTML = '';
                        var p = document.createElement("h3");
                        t = document.createTextNode(configuration.detail.title);
                        p.appendChild(t);
                        element.appendChild(p);
                    }

                    //update description
                    element = document.querySelector(".modal .modal-content .body .description");
                    if (element != undefined) {
                        element.innerHTML = '';
                        var p = document.createElement("p");
                        t = document.createTextNode(configuration.detail.description);
                        p.appendChild(t);
                        element.appendChild(p);
                    }

                    element = document.querySelector(".modal .modal-content .body .link a");
                    element.setAttribute('href', configuration.detail.href);

                    // When the user clicks anywhere outside of the modal, close it
                    window.onclick = function(event) {
                      if (event.target == modal) {
                        event.preventDefault();
                        event.stopPropagation();
                        modal.style.display = "none";
                        gtmYTListeners[0].event.playVideo();
                      }
                    };
                };

                function removedCircleDescriptor(segunsContainer) {

                    var keys = Object.keys(configRemoved);
                    var key = null;

                    for(var i = 0; i < keys.length; i++) {
                        if (keys[i] == segunsContainer) {
                            key = keys[i];
                            break;
                        }
                    }

                    if (key != null) {
                        key = configRemoved[keys[i]];
                        var selector = "div[data-position='"+ key.position +"']";
                        var removed = document.querySelectorAll(selector);
                        if (removed != undefined) {
                            for(var i = 0; i < removed.length; i++) {
                                removed[i].parentNode.removeChild(removed[i]);
                            }
                        }
                    }
                };

                function addCircleDescriptor(segunsContainer) {

                    var views = [];
                    for(var i = 0; i < config.length; i++) {
                        if (config[i].start == segunsContainer) {
                            views.push(i);
                        }
                    }

                    for(var i = 0; i < views.length; i++) {
                        var configInter = config[views[i]];
                        var circle = document.createElement('div');
                        var style = 'position: absolute;background-size: cover;'
                        style += 'background-image: url(' + configInter.img_screen + ');';
                        configInter.position.forEach( function(element) {
                            style += element;
                        });
                        circle.setAttribute('style', style);
                        circle.setAttribute('class', 'circle');
                        circle.setAttribute('data-position', configInter.start);
                        circle.setAttribute('data-reference', views[i]);
                        circle.onclick = function($e) {
                            $e.preventDefault();
                            $e.stopPropagation();
                            gtmYTListeners[0].event.pauseVideo();
                            configureAndShowModal($e);
                        };
                        var base = document.querySelector('.video-container');
                        if (base != undefined) {
                            base.append(circle);

                            /* Enter cricle in screen */
                            console.log('Impresion Bola ' + views[i]);
                        }
                    }
                };

                function _youtubeAPIReady() {}

                _loadScript('https://www.youtube.com/iframe_api', _youtubeAPIReady);
            };

            _initAdds();
        </script>
    </body>
</html>
